name: TSF Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  tsf-validation:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      # ========== CHECKOUT ==========
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for TSF traceability

      # ========== ENVIRONMENT ==========
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ========== DEPENDENCIES ==========
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pyyaml
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Install trudag (TSF tools)
        run: |
          git clone https://gitlab.com/CodethinkLabs/trustable/trustable.git /tmp/trustable
          cd /tmp/trustable
          git checkout 2025.9.16 || git checkout main
          pip install .

      # ========== PREPARE ==========
      - name: Create artifact directories
        run: |
          mkdir -p artifacts/verification/{tests,static-analysis,coverage}
          touch artifacts/verification/{tests,static-analysis,coverage}/.gitkeep

      # ========== TESTS & ANALYSIS ==========
      - name: Run tests with coverage
        id: tests
        continue-on-error: true
        run: |
          if [ -d "tests" ] && find tests -name "*.py" 2>/dev/null | grep -q .; then
            pytest tests/ \
              --junit-xml=artifacts/verification/tests/pytest-results.xml \
              --cov=src --cov=qt/src \
              --cov-report=xml:artifacts/verification/coverage/coverage.xml \
              2>&1 | tee artifacts/verification/tests/pytest.log
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Run static analysis
        id: analysis
        continue-on-error: true
        run: |
          if [ -d "src" ] || [ -d "qt/src" ]; then
            cppcheck --enable=all --suppress=missingIncludeSystem --xml --xml-version=2 \
              src/ qt/src/ 2> artifacts/verification/static-analysis/cppcheck-results.xml
            cppcheck --enable=all --suppress=missingIncludeSystem \
              src/ qt/src/ > artifacts/verification/static-analysis/cppcheck-report.txt 2>&1 || true
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

      # ========== TSF VALIDATION ==========
      - name: Validate TSF requirements
        id: tsf
        run: |
          trudag manage lint 2>&1 | tee artifacts/trudag-lint.txt

      - name: Calculate scores
        id: score
        continue-on-error: true
        run: |
          trudag score 2>&1 | tee artifacts/trudag-score.txt

      - name: Generate report
        id: publish
        continue-on-error: true
        run: |
          mkdir -p artifacts/trustable-report
          trudag publish --output-dir artifacts/trustable-report --no-validate 2>&1 || true

      # ========== UPLOAD & REPORT ==========
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tsf-validation-artifacts
          path: artifacts/
          retention-days: 30

      - name: Extract summary
        id: summary
        if: always()
        run: |
          echo "lint<<EOF" >> $GITHUB_OUTPUT
          head -n 20 artifacts/trudag-lint.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ” TSF Validation

            | Check | Status |
            |-------|--------|
            | **Tests** | ${{ steps.tests.outputs.status == 'success' && 'âœ…' || (steps.tests.outputs.status == 'skipped' && 'â­ï¸' || 'âŒ') }} |
            | **Analysis** | ${{ steps.analysis.outputs.status == 'success' && 'âœ…' || (steps.analysis.outputs.status == 'skipped' && 'â­ï¸' || 'âŒ') }} |
            | **TSF Lint** | ${{ steps.tsf.outcome == 'success' && 'âœ…' || 'âŒ' }} |
            | **Score** | ${{ steps.score.outcome == 'success' && 'âœ…' || 'âš ï¸' }} |
            | **Report** | ${{ steps.publish.outcome == 'success' && 'âœ…' || 'âš ï¸' }} |

            <details>
            <summary>ğŸ“‹ Lint Output</summary>

            ```
            ${{ steps.summary.outputs.lint }}
            ```
            </details>

            ğŸ“¦ [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # ========== ENFORCE ==========
      - name: Check TSF validation
        if: steps.tsf.outcome != 'success'
        run: |
          echo "âŒ TSF lint failed"
          exit 1
